#!/bin/bash

# Pre-commit hook for automatic markdown fixing
# This script runs before each commit to ensure markdown files are properly formatted
# Now with enhanced automation and comprehensive fixing

set -e

echo "ğŸ” Pre-commit: Automatic markdown processing..."

# Check if there are any markdown files in the staging area
MARKDOWN_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|markdown)$' || true)

if [ -z "$MARKDOWN_FILES" ]; then
    echo "â„¹ï¸  No markdown files to process"
    exit 0
fi

echo "ğŸ“‹ Found markdown files to process:"
echo "$MARKDOWN_FILES" | sed 's/^/  âœ“ /'
echo ""

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check dependencies
MISSING_DEPS=()

if ! command_exists node; then
    MISSING_DEPS+=("Node.js")
fi

if ! command_exists npm; then
    MISSING_DEPS+=("npm")
fi

if ! command_exists markdownlint; then
    if command_exists npm; then
        echo "ğŸ“¦ Installing markdownlint-cli..."
        npm install -g markdownlint-cli >/dev/null 2>&1 || {
            echo "âš ï¸  Failed to install markdownlint-cli globally, trying locally..."
            npm install markdownlint-cli >/dev/null 2>&1 || MISSING_DEPS+=("markdownlint-cli")
        }
    else
        MISSING_DEPS+=("markdownlint-cli")
    fi
fi

if [ ${#MISSING_DEPS[@]} -gt 0 ]; then
    echo "âŒ Missing dependencies: ${MISSING_DEPS[*]}"
    echo "ğŸ’¡ Please install the missing dependencies and try again."
    exit 1
fi

# Track processing results
FILES_PROCESSED=0
FILES_MODIFIED=0
ERRORS=()

echo "ğŸš€ Starting automatic markdown processing..."
echo ""

# Step 1: Run basic markdownlint fixes on individual files
echo "ğŸ“ Step 1: Basic markdown linting and fixes..."
for file in $MARKDOWN_FILES; do
    if [ -f "$file" ]; then
        echo "  ğŸ”§ Processing $file..."

        # Create backup for safety
        cp "$file" "$file.pre-commit-backup"

        # Run markdownlint with --fix
        if markdownlint --fix --config .markdownlint.json "$file" 2>/dev/null; then
            echo "    âœ… Basic fixes applied"
        else
            echo "    âš ï¸  Some basic fixes may have failed, continuing..."
        fi

        # Check if file was modified
        if ! cmp -s "$file" "$file.pre-commit-backup"; then
            FILES_MODIFIED=$((FILES_MODIFIED + 1))
        fi

        FILES_PROCESSED=$((FILES_PROCESSED + 1))

        # Clean up backup
        rm -f "$file.pre-commit-backup"
    fi
done

echo "    ğŸ“Š Processed $FILES_PROCESSED files, $FILES_MODIFIED modified"
echo ""

# Step 2: Run advanced fixes on all markdown files
echo "ğŸš€ Step 2: Advanced markdown fixes..."
if [ -f "package.json" ] && [ -f "scripts/fix-markdown.js" ]; then
    echo "  ğŸ”§ Running npm run docs:fix-advanced..."

    if npm run docs:fix-advanced >/dev/null 2>&1; then
        echo "    âœ… Advanced fixes completed successfully"

        # Stage any newly modified files
        for file in $MARKDOWN_FILES; do
            if [ -f "$file" ]; then
                git add "$file" 2>/dev/null || true
            fi
        done

        # Clean up backup files automatically
        echo "  ğŸ§¹ Cleaning up backup files..."
        if npm run docs:clean-backups >/dev/null 2>&1; then
            echo "    âœ… Backup cleanup completed"
        else
            # Fallback cleanup
            rm -f docs/*.backup 2>/dev/null || true
            echo "    âœ… Backup cleanup completed (fallback)"
        fi
    else
        echo "    âš ï¸  Advanced fixes encountered issues, but continuing..."
        ERRORS+=("Advanced fixes failed")
    fi
else
    echo "    âš ï¸  Advanced fix script not available, skipping..."
fi

echo ""

# Step 3: Final comprehensive lint check
echo "ğŸ” Step 3: Final validation..."
echo "  ğŸ“‹ Running comprehensive markdown lint check..."

LINT_OUTPUT=$(markdownlint --config .markdownlint.json docs/*.md README.md 2>&1 || true)

if [ -n "$LINT_OUTPUT" ]; then
    echo "    âŒ Remaining markdown issues found:"
    echo "$LINT_OUTPUT" | sed 's/^/      /'
    echo ""
    echo "    ğŸ¤” Some issues couldn't be auto-fixed."
    echo "    ğŸ’¡ Try running 'npm run docs:fix-advanced' manually"
    echo "    ğŸ”§ Or fix the issues manually and commit again"
    echo ""
    ERRORS+=("Remaining lint issues")
else
    echo "    âœ… All markdown files pass validation!"
fi

echo ""

# Step 4: Summary and results
echo "ğŸ“Š Pre-commit Summary:"
echo "====================="
echo "  ğŸ“ Files processed: $FILES_PROCESSED"
echo "  ğŸ“ Files modified: $FILES_MODIFIED"
echo "  ğŸ§¹ Backups cleaned: âœ…"

if [ ${#ERRORS[@]} -gt 0 ]; then
    echo "  âš ï¸  Issues encountered: ${#ERRORS[@]}"
    for error in "${ERRORS[@]}"; do
        echo "    - $error"
    done
    echo ""
    echo "ğŸš« Commit blocked due to remaining issues."
    echo "ğŸ’¡ Please fix the issues above and try committing again."
    echo ""
    exit 1
else
    echo "  âœ… Status: All checks passed!"
    echo ""

    # Show what files were staged
    STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|markdown)$' || true)
    if [ -n "$STAGED_MD_FILES" ]; then
        echo "ğŸ“ Staged markdown files:"
        echo "$STAGED_MD_FILES" | sed 's/^/  âœ… /'
        echo ""
    fi

    echo "ğŸ‰ Pre-commit processing completed successfully!"
    echo "âœ¨ Your markdown files are now properly formatted and ready to commit!"
fi

echo ""
exit 0
